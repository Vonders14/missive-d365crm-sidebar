<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dynamics 365 CRM for Missive</title>

  <!-- Missive styling -->
  <link rel="stylesheet" href="https://integrations.missiveapp.com/missive.css">
  <script src="https://integrations.missiveapp.com/js/sdk.js"></script>
  <script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>

  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;padding:12px}
    .card{border:1px solid #e0e0e0;border-radius:8px;padding:10px;margin-bottom:8px}
    .title{font-weight:600}
    .small{font-size:12px;color:#666}
    .btn{background:#0078d4;color:#fff;border:none;border-radius:4px;padding:6px 10px;font-size:12px;cursor:pointer}
    .btn:hover{opacity:.9}
    #loading{text-align:center;margin-top:20px}
    .error{color:#d13438;padding:12px;background:#fef0f0;border-radius:4px;margin:12px}
  </style>
</head>
<body>
  <div id="loading">Connecting to Dynamics 365…</div>
  <div id="content" style="display:none"></div>

<script>
/* ========= CONFIG ========= */
const CONFIG = {
  d365BaseUrl: "https://orgc52882f8.crm.dynamics.com",
  tenantId: "577d8419-3be9-41e2-b4f6-97cc5bd1ec18",
  clientId: "0e85f610-f6d0-4c03-87da-e5a5598b6961"
};
/* ========================== */

function showError(msg) {
  console.error(msg);
  document.getElementById("loading").innerHTML = `<div class="error">Error: ${msg}<br><small>Check browser console (F12) for details</small></div>`;
}

const msalApp = new msal.PublicClientApplication({
  auth: {
    clientId: CONFIG.clientId,
    authority: `https://login.microsoftonline.com/${CONFIG.tenantId}`,
    redirectUri: window.location.origin
  }
});

async function getToken() {
  try {
    const scopes = [`${CONFIG.d365BaseUrl}/.default`];
    let account = msalApp.getAllAccounts()[0];
    if (!account) {
      const loginRes = await msalApp.loginPopup({ scopes });
      account = loginRes.account;
    }
    
    try {
      const res = await msalApp.acquireTokenSilent({ scopes, account });
      return res.accessToken;
    } catch (silentError) {
      console.log("Silent token acquisition failed, using popup", silentError);
      const res = await msalApp.acquireTokenPopup({ scopes });
      return res.accessToken;
    }
  } catch (error) {
    showError(`Authentication failed: ${error.message}`);
    throw error;
  }
}

async function queryD365(entity, filter, token) {
  try {
    const r = await fetch(`${CONFIG.d365BaseUrl}/api/data/v9.2/${entity}?$filter=${filter}`, {
      headers: { Authorization: `Bearer ${token}` }
    });
    
    if (!r.ok) {
      const errorText = await r.text();
      throw new Error(`D365 API returned ${r.status}: ${errorText}`);
    }
    
    return await r.json();
  } catch (error) {
    showError(`Failed to query Dynamics 365: ${error.message}`);
    throw error;
  }
}

async function loadCRM(email) {
  try {
    console.log("Loading CRM data for:", email);
    document.getElementById("loading").textContent = `Searching Dynamics 365 for ${email}…`;
    const token = await getToken();

    const contacts = await queryD365("contacts", `emailaddress1 eq '${email}'`, token);
    if (!contacts.value || contacts.value.length === 0) {
      document.getElementById("loading").textContent = "No contact found in Dynamics 365.";
      return;
    }

    const c = contacts.value[0];
    const accountName = c["_parentcustomerid_value@OData.Community.Display.V1.FormattedValue"] || "—";
    const contactId = c.contactid;

    // opportunities for that contact
    const opps = await queryD365("opportunities", `_parentcontactid_value eq ${contactId}`, token);

    let html = `
      <div class="card">
        <div class="title">${c.fullname || 'Unknown'}</div>
        <div class="small">${c.emailaddress1}</div>
        <div class="small">Account · ${accountName}</div>
        <div class="small">Stage · ${c.cr78a_contactstage || "—"}</div>
        <button class="btn" onclick="window.open('${CONFIG.d365BaseUrl}/main.aspx?etn=contact&id=${contactId}','_blank')">Open in D365 ↗</button>
      </div>`;

    if (opps.value && opps.value.length > 0) {
      html += `<div class="card"><div class="title">Opportunities</div>`;
      opps.value.forEach(o => {
        html += `<div class="small">• ${o.name || "(Unnamed)"} — ${o["stepname"] || ""}</div>`;
      });
      html += `</div>`;
    }

    document.getElementById("content").innerHTML = html;
    document.getElementById("loading").style.display = "none";
    document.getElementById("content").style.display = "block";
  } catch (error) {
    console.error("Error in loadCRM:", error);
    showError(error.message);
  }
}

async function initMissive() {
  try {
    console.log("Initializing Missive integration...");
    console.log("Missive SDK available:", typeof Missive !== 'undefined');
    
    await Missive.initialize();
    console.log("Missive initialized successfully");
    
    Missive.on("change:conversations", async ids => {
      console.log("Conversation changed:", ids);
      if (!ids.length) return;
      try {
        const convs = await Missive.fetchConversations(ids);
        if (convs && convs[0] && convs[0].latest_message && convs[0].latest_message.from_field) {
          const email = convs[0].latest_message.from_field.address;
          document.getElementById("content").style.display = "none";
          document.getElementById("loading").style.display = "block";
          document.getElementById("loading").textContent = "Connecting to Dynamics 365…";
          await loadCRM(email);
        }
      } catch (error) {
        console.error("Error handling conversation change:", error);
        showError(`Failed to load conversation: ${error.message}`);
      }
    });

    const conv = await Missive.fetchConversations();
    console.log("Current conversations:", conv);
    if (conv && conv.length > 0 && conv[0].latest_message && conv[0].latest_message.from_field) {
      const email = conv[0].latest_message.from_field.address;
      await loadCRM(email);
    } else {
      document.getElementById("loading").textContent = "Select a conversation to view CRM data.";
    }
  } catch (error) {
    console.error("Error in initMissive:", error);
    showError(`Initialization failed: ${error.message}`);
  }
}

// Wait for DOM and scripts to load
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initMissive);
} else {
  initMissive();
}
</script>
</body>
</html>